USE [ES25]
GO
/****** Object:  StoredProcedure [dbo].[sp_attendance]    Script Date: 6/20/2022 2:58:40 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[sp_attendance]
@comid nvarchar(250)=null,
@userid int=null,
@departmentid int=null,
@subdepartmentid int=null,
@designationid int=null,
@attendate date=null,
@attentime nvarchar(50)=null,
@attenstatus int=null,
@attenplace int=null,
@attenremarks int=null,
@fiscalid int=null,
@branchid int=null,
@tblshiftres datetime=null,
@leftearly datetime=null,
@repflag nvarchar(250)=null,
@iflag nvarchar(50) = null,
@value nvarchar(50)=null,
@jsonstring nvarchar(max)=null,
@flag nvarchar(250)
as
BEGIN
	if(@flag = 'createattendance')
	begin
		if not exists(Select 'm' from tbl_user where ID = @userid)
		begin
			Select 203 StatusCode, 'User does not exists' Message
			return;
		end
		if exists(Select 'm' from tbl_attendance where user_id = @userid and com_id=@comid and attend_date=@attendate and attend_status=1)
		begin
			set @attenstatus = 2
		end
		else
		begin
			set @attenstatus = 1
		end
		if exists(Select 'm' from tbl_attendance where user_id = @userid and com_id=@comid and attend_date=@attendate and attend_status=2)
		begin
			Select 400 StatusCode, 'Attendance already completed' Message
			return;
		end
		set @tblshiftres=(select dateadd(minute, datediff(minute,convert(datetime,shift_start), convert(datetime,allowed_late_in)),convert(datetime,shift_start)) from tbl_shift)
		set @leftearly=(select dateadd(minute, datediff(minute,convert(datetime,shift_end), convert(datetime,allowed_early_out)),convert(datetime,shift_end)) from tbl_shift)
		if (((convert(datetime,@attentime))<=@tblshiftres) and @attenstatus = 1)
		begin
			set @attenremarks = 1
		end
		else if(((convert(datetime,@attentime))>@tblshiftres) and @attenstatus = 1)
		begin
			set @attenremarks = 3
		end
		else if(((convert(datetime,@attentime))<@leftearly) and @attenstatus = 2)
		begin
			set @attenremarks = 4
		end
		else if(((convert(datetime,@attentime))>=@leftearly) and @attenstatus = 2)
		begin
			set @attenremarks = 1
		end
		else
		begin
			set @attenremarks = 2
		end
		Insert into tbl_attendance(com_id,user_id,department_id,sub_department_id,designation_id,attend_date,attend_time,attend_status,
		attend_place, attend_remarks, fiscal_id, branch_id,status,attend_verified,updated_by,created_by,created_date,updated_date)
		values(@comid,@userid,@departmentid,@subdepartmentid,@designationid,@attendate,@attentime,@attenstatus,@attenplace,@attenremarks,
		@fiscalid,@branchid,1,0,@userid,@userid,GETDATE(),GETDATE())
		Select 200 StatusCode, 'Success' Message
		return;
	end

	if(@flag = 'attendancereport')
	begin
		if not exists (Select 'm' from tbl_user where ID=@userid)
		begin
			Select 203 StatusCode, 'User does not exists' Message
			return;
		end
		if(@repflag='m')
		begin
			select distinct(format(attend_date, 'yyyy-MM-dd')) AttenDate, day (attend_date) AttenDay, 
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and day(attend_date)=day(t.attend_date) and month(attend_date)=@value) CheckIn,
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and day(attend_date)=day(t.attend_date) and month(attend_date)=@value) CheckOut,
			case status
			when 1 then 'Check In'
			when 2 then 'Check Out'
			end Status,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and day(attend_date)=day(t.attend_date) and month(attend_date)=@value) 
			when 1 then 'Present'
			when 3 then 'Late'
			end InRemarks,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and day(attend_date)=day(t.attend_date) and month(attend_date)=@value)
			when 4 then 'left early'
			end OutRemarks,
			attend_place Via, attend_verified IsVerified, verified_by VerifiedBy
			from tbl_attendance t
			where com_id=@comid and user_id=@userid and month(attend_date)=@value and status = 1
		end
		if(@repflag='d')
		begin
			select distinct(format(attend_date, 'yyyy-MM-dd')) AttenDate, day(attend_date) AttenDay, 
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and attend_date=convert(datetime,@value)) CheckIn,--day(attend_date)=day(@value) and month(attend_date)=month(@value) and year(attend_date)=year(@value)) CheckIn,
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and attend_date=convert(datetime,@value)) CheckOut,
			case status
			when 1 then 'Check In'
			when 2 then 'Check Out'
			end Status,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and attend_date=convert(datetime,@value)) 
			when 1 then 'Present'
			when 3 then 'Late'
			end InRemarks,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and attend_date=convert(datetime,@value)) 
			when 4 then 'Left early'
			end OutRemarks,
			attend_place Via, attend_verified IsVerified, verified_by VerifiedBy
			from tbl_attendance t
			where com_id=@comid and user_id=@userid and attend_date=convert(datetime,@value) and status = 1
		end
	end
END