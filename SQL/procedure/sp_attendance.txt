USE [ES25]
GO
/****** Object:  StoredProcedure [dbo].[sp_attendance]    Script Date: 6/21/2022 10:22:53 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER proc [dbo].[sp_attendance]
@comid nvarchar(250)=null,
@userid int=null,
@departmentid int=null,
@subdepartmentid int=null,
@designationid int=null,
@attendate date=null,
@attentime nvarchar(50)=null,
@attenstatus int=null,
@attenplace int=null,
@attenremarks int=null,
@fiscalid int=null,
@branchid int=null,
@tblshiftres datetime=null,
@leftearly datetime=null,
@repflag nvarchar(250)=null,
@iflag nvarchar(50) = null,
@value nvarchar(50)=null,
@jsonstring nvarchar(max)=null,
@datecount int =null,
@presentcount int=null,
@flag nvarchar(250)
as
BEGIN
	if(@flag = 'createattendance')
	begin
		if not exists(Select 'm' from tbl_user where ID = @userid)
		begin
			Select 203 StatusCode, 'User does not exists' Message
			return;
		end
		if exists(Select 'm' from tbl_attendance where user_id = @userid and com_id=@comid and attend_date=@attendate and attend_status=1)
		begin
			set @attenstatus = 2
		end
		else
		begin
			set @attenstatus = 1
		end
		if exists(Select 'm' from tbl_attendance where user_id = @userid and com_id=@comid and attend_date=@attendate and attend_status=2)
		begin
			Select 400 StatusCode, 'Attendance already completed' Message
			return;
		end
		set @tblshiftres=(select dateadd(minute, datediff(minute,convert(datetime,shift_start), convert(datetime,allowed_late_in)),convert(datetime,shift_start)) from tbl_shift)
		set @leftearly=(select dateadd(minute, datediff(minute,convert(datetime,shift_end), convert(datetime,allowed_early_out)),convert(datetime,shift_end)) from tbl_shift)
		if (((convert(datetime,@attentime))<=@tblshiftres) and @attenstatus = 1)
		begin
			set @attenremarks = 1
		end
		else if(((convert(datetime,@attentime))>@tblshiftres) and @attenstatus = 1)
		begin
			set @attenremarks = 3
		end
		else if(((convert(datetime,@attentime))<@leftearly) and @attenstatus = 2)
		begin
			set @attenremarks = 4
		end
		else if(((convert(datetime,@attentime))>=@leftearly) and @attenstatus = 2)
		begin
			set @attenremarks = 5
		end
		else
		begin
			set @attenremarks = 2
		end
		Insert into tbl_attendance(com_id,user_id,department_id,sub_department_id,designation_id,attend_date,attend_time,attend_status,
		attend_place, attend_remarks, fiscal_id, branch_id,status,attend_verified,updated_by,created_by,created_date,updated_date)
		values(@comid,@userid,@departmentid,@subdepartmentid,@designationid,@attendate,@attentime,@attenstatus,@attenplace,@attenremarks,
		@fiscalid,@branchid,1,0,@userid,@userid,GETDATE(),GETDATE())
		Select 200 StatusCode, 'Success' Message
		return;
	end

	if(@flag = 'attendancereport')
	begin
		if not exists (Select 'm' from tbl_user where ID=@userid)
		begin
			Select 203 StatusCode, 'User does not exists' Message
			return;
		end
		if(@repflag='m')
		begin			
		
			Select distinct(attend_date) into #workdate from tbl_attendance where format(attend_date, 'yyyy-MM')=@value
			-----------------
			select distinct(format(d.attend_date, 'yyyy-MM-dd')) AttenDate, day (d.attend_date) AttenDay, 
			isnull((Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and day(attend_date)=day(d.attend_date) and format(attend_date, 'yyyy-MM')=@value),'No Checkin') CheckIn,
			isnull((Select attend_time from tbl_attendance where user_id=@userid and com_id='es25' and attend_status=2 and day(attend_date)=day(d.attend_date) and format(attend_date, 'yyyy-MM')=@value),'No Checkout')  CheckOut,

			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and day(attend_date)=day(d.attend_date) and format(attend_date, 'yyyy-MM')=@value) 
			when 1 then 'Early In'
			when 2 then 'On Time'
			when 3 then 'Late'
			when null then 'No Checkin'
			end InRemarks,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and day(attend_date)=day(d.attend_date) and format(attend_date, 'yyyy-MM')=@value)
			when 2 then 'On Time'
			when 4 then 'left early'
			when 5 then 'after office'
			else 'No Checkout'
			end OutRemarks,
			isnull(attend_place,'-') Via, isnull(attend_verified,'-') IsVerified, isnull(verified_by,'-') VerifiedBy
			from #workdate d
			left join tbl_attendance t on t.attend_date=d.attend_date and format(d.attend_date, 'yyyy-MM')=@value and com_id=@comid and user_id=@userid and status = 1
			----------
			drop table #workdate
		end
		if(@repflag='d')
		begin
			select distinct(format(attend_date, 'yyyy-MM-dd')) AttenDate, day(attend_date) AttenDay, 
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and attend_date=convert(datetime,@value)) CheckIn,--day(attend_date)=day(@value) and month(attend_date)=month(@value) and year(attend_date)=year(@value)) CheckIn,
			(Select attend_time from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and attend_date=convert(datetime,@value)) CheckOut,
			case status
			when 1 then 'Check In'
			when 2 then 'Check Out'
			end Status,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=1 and attend_date=convert(datetime,@value)) 
			when 1 then 'Present'
			when 3 then 'Late'
			end InRemarks,
			case (Select attend_remarks from tbl_attendance where user_id=@userid and com_id=@comid and attend_status=2 and attend_date=convert(datetime,@value)) 
			when 4 then 'Left early'
			end OutRemarks,
			attend_place Via, attend_verified IsVerified, verified_by VerifiedBy
			from tbl_attendance t
			where com_id=@comid and user_id=@userid and attend_date=convert(datetime,@value) and status = 1
		end
	end


	IF(@flag='attendancesummary')
	Begin
		if not exists (Select 'm' from tbl_user where ID=@userid)
		begin
			Select 202 StatusCode, 'User does not exists' Message
			return;
		end
		if not (@repflag='m' or @repflag='y')
		begin
			Select 203 StatusCode, 'Flag does not exists' Message
			return;
		End
		if(@repflag='m')
		begin
			--set @datecount = (Select count(distinct(attend_date)) from tbl_attendance where year(attend_date)=@value);
			--set @presentcount = (Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=@value);
			Select distinct(month(attend_date)) ID ,
			case month(attend_date)
			when 01 then 'January'
			when 02 then 'Febuary'
			when 03 then 'March'
			when 04 then 'April'
			when 05 then 'May'
			when 06 then 'June'
			when 07 then 'July'
			when 08 then 'August'
			when 09 then 'September'
			when 10 then 'October'
			when 11 then 'November'
			when 12 then 'December'
			end Name,
			(Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=@value and MONTH(attend_date)=month(a.attend_date) and status=1) TotalPresent,
			((Select count(distinct(attend_date)) from tbl_attendance where year(attend_date)=@value and MONTH(attend_date)=month(a.attend_date) and status=1)-
			(Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=@value and MONTH(attend_date)=month(a.attend_date) and status=1)) TotalAbsent
			from tbl_attendance a
			where user_id=@userid and com_id=@comid and year(attend_date)=@value and status=1
		end

		if(@repflag='y')
		begin
			--set @datecount = (Select count(distinct(attend_date)) from tbl_attendance where year(attend_date)=@value);
			--set @presentcount = (Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=@value);
			Select distinct(year(a.attend_date)) ID,
			year(a.attend_date) Name,
			(Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=year(a.attend_date) and status=1 and attend_status=2 group by attend_date) TotalPresent,
			((Select count(distinct(attend_date)) from tbl_attendance where year(attend_date)=year(a.attend_date) and attend_status=2 and status=1 group by attend_date)-
			(Select count(distinct(attend_date)) from tbl_attendance where attend_remarks<>2 and user_id=@userid and com_id=@comid and year(attend_date)=year(a.attend_date) and status=1 and attend_status=2 group by attend_date)) TotalAbsent
			from tbl_attendance a
			where user_id=@userid and com_id=@comid and status=1
		end
			
	End
END