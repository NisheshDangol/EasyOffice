USE [ES25]
GO
/****** Object:  StoredProcedure [dbo].[sp_leads]    Script Date: 5/15/2022 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[sp_leads]
(
@ID int=NULL,
@CompanyId nvarchar(250)=NULL,
@OrganizationId int=NULL,
@ProductId int=NULL,
@EnquiryDate date =NULL,
@EnquiryTime time=NULL,
@LeadStatus int=NULL,
@Assignedto int=NULL,
@Remarks nvarchar(250)=NULL,
@EmpId int=NULL,
@BranchId int=NULL,
@FiscalId int=NULL,
@flag nvarchar(50),
@LeadSource int=NULL
)
As
BEGIN
IF @flag='CreateLead'
BEGIN
	if not exists (select 'm' from tbl_organization where ID = @OrganizationId)
	begin
		select 202 StatusCode , 'OrganizationID does not match' Message
		return;
	end
	else
	begin
		insert into tbl_leads(
		  com_id, created_by, org_id, product_id, 
		  enquiry_date, enquiry_time, assigned_to, 
		  remarks, lead_status, branch_id, 
		  fiscal_id, updated_by, status,created_date,updated_date,lead_source
		) 
		values 
		  (
			@CompanyId, @EmpId, @OrganizationId, 
			@ProductId, @EnquiryDate, @EnquiryTime, 
			@Assignedto, @Remarks, @LeadStatus, 
			@BranchId, @FiscalId, @EmpId, 1,(select dbo.fndate()),(select dbo.fndate()),@LeadSource
		  )
		  select 200 StatusCode, 'Lead Inserted Successfully' Message
		  return;
	end



END


IF @flag='leadsource'
BEGIN
	if not exists(select 'm' from tbl_branch where ID = @BranchId)
	begin
		select 202 StatusCode, 'Branch Id does not exists' Message
		return;
	end
	else
	begin
		
		Select l.lead_source SourceID,ls.name SourceName, count(l.ID) LeadCount, 
		(select Count(Id) from tbl_organization where comp_id= @CompanyId and status=1 and branch_id=@BranchId and ID=l.org_id) OrganizationCount
		from tbl_leads l
		left join tbl_lead_source ls on ls.ID=l.lead_source

		where ls.com_id=@CompanyId and ls.branch_id=@BranchId and ls.status=1 
		group by l.lead_source,ls.name, l.com_id,l.org_id
		select 200 StatusCode , 'Success' Message
	end
	END


END