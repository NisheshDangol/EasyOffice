USE [ES25]
GO
/****** Object:  StoredProcedure [dbo].[sp_all_org_list]    Script Date: 5/6/2022 10:32:17 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[sp_all_org_list](
@isourclient int =Null,
@companyid nvarchar(10) = NULL,
@userid int = NULL,
@FromDate nvarchar(500)=NULL,
@ToDate nvarchar(500) = NULL,
@orgtype int =NULL,
@sourceid int= NULL
) as

BEGIN
	if @isourclient=-1
	BEGIN
		if (@orgtype=-1 and @sourceid=-1)
		begin
			select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
			o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
			o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
			COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
			from tbl_organization as o 
			left join tbl_user as u on o.assigned_to=u.ID
			left join tbl_organizationtype as t on o.org_type=t.Id
			left join tbl_leads as l on l.com_id=o.Id
			left join tbl_follow_up as f on f.com_id=o.Id
			left join tbl_customer_support as s on s.com_id=o.Id
			where comp_id=@companyid and o.created_by=@userid and o.added_date>=@FromDate and o.added_date<=@ToDate
			group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
			return;
		end		
		else if @orgtype=-1
		begin
			select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
			o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
			o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
			COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
			from tbl_organization as o 
			left join tbl_user as u on o.assigned_to=u.ID
			left join tbl_organizationtype as t on o.org_type=t.Id
			left join tbl_leads as l on l.com_id=o.Id
			left join tbl_follow_up as f on f.com_id=o.Id
			left join tbl_customer_support as s on s.com_id=o.Id
			where comp_id=@companyid and o.created_by=@userid and o.source=@sourceid and o.added_date>=@FromDate and o.added_date<=@ToDate
			group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
			return;
		end
		else if @sourceid=-1
		begin
			select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
			o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
			o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
			COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
			from tbl_organization as o 
			left join tbl_user as u on o.assigned_to=u.ID
			left join tbl_organizationtype as t on o.org_type=t.Id
			left join tbl_leads as l on l.com_id=o.Id
			left join tbl_follow_up as f on f.com_id=o.Id
			left join tbl_customer_support as s on s.com_id=o.Id
			where comp_id=@companyid and o.created_by=@userid and o.org_type=@orgtype and o.added_date>=@FromDate and o.added_date<=@ToDate
			group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
			return;
		end
		else
		begin
			select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
			o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
			o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
			COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
			from tbl_organization as o 
			left join tbl_user as u on o.assigned_to=u.ID
			left join tbl_organizationtype as t on o.org_type=t.Id
			left join tbl_leads as l on l.com_id=o.Id
			left join tbl_follow_up as f on f.com_id=o.Id
			left join tbl_customer_support as s on s.com_id=o.Id
			where comp_id=@companyid and o.created_by=@userid and o.org_type=@orgtype and o.source = @sourceid and o.added_date>=@FromDate and o.added_date<=@ToDate
			group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
			return;
		end
	
	END
	Else
	BEGIN
	if (@orgtype=-1 and @sourceid=-1)
	begin
		select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
		o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
		o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
		COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
		from tbl_organization as o 
		left join tbl_user as u on o.assigned_to=u.ID
		left join tbl_organizationtype as t on o.org_type=t.Id
		left join tbl_leads as l on l.com_id=o.Id
		left join tbl_follow_up as f on f.com_id=o.Id
		left join tbl_customer_support as s on s.com_id=o.Id
		where o.comp_id=@companyid and o.created_by=@userid and is_our_client=@isourclient and o.added_date>=@FromDate and o.added_date<=@ToDate
		group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
		return;
	end		
	else if @orgtype=-1
	begin
		select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
		o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
		o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
		COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
		from tbl_organization as o 
		left join tbl_user as u on o.assigned_to=u.ID
		left join tbl_organizationtype as t on o.org_type=t.Id
		left join tbl_leads as l on l.com_id=o.Id
		left join tbl_follow_up as f on f.com_id=o.Id
		left join tbl_customer_support as s on s.com_id=o.Id
		where comp_id=@companyid and o.created_by=@userid and o.source=@sourceid and is_our_client=@isourclient and o.added_date>=@FromDate and o.added_date<=@ToDate
		group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
		return;
	end
	else if @sourceid=-1
	begin
		select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
		o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
		o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
		COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
		from tbl_organization as o 
		left join tbl_user as u on o.assigned_to=u.ID
		left join tbl_organizationtype as t on o.org_type=t.Id
		left join tbl_leads as l on l.com_id=o.Id
		left join tbl_follow_up as f on f.com_id=o.Id
		left join tbl_customer_support as s on s.com_id=o.Id
		where comp_id=@companyid and o.created_by=@userid and o.org_type=@orgtype and is_our_client=@isourclient and o.added_date>=@FromDate and o.added_date<=@ToDate
		group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
		return;
	end
	else
	begin
	select o.Id as OrgId,o.org_name as OrgName,t.name as OrgType,o.address as Address,
		o.district as District,o.phone_no as Phone,o.cperson_contact as ContectPerson,
		o.assigned_to AssignedTo,u.user_name as StaffName,COUNT(l.Id) as LeadCount,
		COUNT(f.Id) as FollowCount,COUNT(s.Id) as SupportCount
		from tbl_organization as o 
		left join tbl_user as u on o.assigned_to=u.ID
		left join tbl_organizationtype as t on o.org_type=t.Id
		left join tbl_leads as l on l.com_id=o.Id
		left join tbl_follow_up as f on f.com_id=o.Id
		left join tbl_customer_support as s on s.com_id=o.Id and o.org_type=@orgtype and o.source = @sourceid
		where comp_id=@companyid and o.created_by=@userid and o.org_type=@orgtype and is_our_client=@isourclient and o.added_date>=@FromDate and o.added_date<=@ToDate
		group by o.Id,o.org_name,t.name,o.address,o.district,o.phone_no,o.cperson_contact,o.assigned_to,u.user_name
		return;
	end
	END

END
